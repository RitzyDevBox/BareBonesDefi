<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Child (Partner) â€” Shim Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 12px; }
    button { margin: 4px 6px 4px 0; }
    pre { background: #f6f6f6; padding: 8px; border-radius: 6px; }
  </style>
</head>
<body>
  <h3>Child Iframe (Partner App)</h3>
  <div>
    <button id="btnReq">Request Accounts</button>
    <button id="btnChain">Get ChainId</button>
    <button id="btnBal">Get Balance (of connected)</button>
    <button id="btnSwitch">Switch to Polygon</button>
    <button id="btnSign">personal_sign</button>
    <button id="btnSendNative">Send 0.01 Native</button>
  </div>
  <pre id="log"></pre>

  <script src="js/ethers-shim.js"></script>
  <script type="module">

    const logEl = document.getElementById('log');
    const log = (...a) => { logEl.textContent += a.map(x => (typeof x === 'string' ? x : JSON.stringify(x))).join(' ') + '\n'; };

    function toHex(n) { return '0x' + BigInt(n).toString(16); }

    document.getElementById('btnReq').addEventListener('click', async () => {
    try {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        log("accounts:", accounts);
    } catch (e) { log("err:", e.message || String(e)); }
    });

    document.getElementById('btnChain').addEventListener('click', async () => {
    try {
        const chainId = await window.ethereum.request({ method: "eth_chainId" });
        log("chainId:", chainId);
    } catch (e) { log("err:", e.message || String(e)); }
    });

    document.getElementById('btnBal').addEventListener('click', async () => {
    try {
        const accts = await window.ethereum.request({ method: "eth_accounts" });
        if (!accts?.length) return log("no account");
        const bal = await window.ethereum.request({ method: "eth_getBalance", params: [accts[0], "latest"] });
        log("balance:", bal);
    } catch (e) { log("err:", e.message || String(e)); }
    });

    document.getElementById('btnSwitch').addEventListener('click', async () => {
    try {
        const res = await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: "0x89" }] // polygon
        });
        log("switch result:", res ?? "(ok)");
    } catch (e) { log("switch err:", e.message || String(e)); }
    });

    document.getElementById('btnSign').addEventListener('click', async () => {
    try {
        const [addr] = await window.ethereum.request({ method: "eth_accounts" });
        const msg = "Hello from child shim";
        // personal_sign params: [data, address]
        const sig = await window.ethereum.request({ method: "personal_sign", params: [msg, addr] });
        log("signature:", sig);
    } catch (e) { log("sign err:", e.message || String(e)); }
    });

    document.getElementById('btnSendNative').addEventListener('click', async () => {
        try {
        const [from] = await window.ethereum.request({ method: "eth_accounts" });
        if (!from) throw new Error("No account connected");
    
        // Example: send 0.01 ETH/MATIC to self
        const tx = {
            from,
            to: from, // replace with a real recipient
            value: "0x" + (BigInt(1e16)).toString(16), // 0.01 ETH in wei
        };
    
        const hash = await window.ethereum.request({
            method: "eth_sendTransaction",
            params: [tx],
        });
    
        log("native tx hash:", hash);
        } catch (e) {
        log("send err:", e.message || String(e));
        }
    });
    

    // Listen to events like a normal dapp
    window.ethereum.on("accountsChanged", (accs) => log("event: accountsChanged", accs));
    window.ethereum.on("chainChanged", (cid) => log("event: chainChanged", cid));

  </script>
</body>
</html>
